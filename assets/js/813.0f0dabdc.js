(window.webpackJsonp=window.webpackJsonp||[]).push([[813],{1439:function(s,t,n){"use strict";n.r(t);var a=n(15),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"doris-on-es"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#doris-on-es"}},[s._v("#")]),s._v(" Doris On ES")]),s._v(" "),n("p",[s._v("Doris-On-ES将Doris的分布式查询规划能力和ES(Elasticsearch)的全文检索能力相结合，提供更完善的OLAP分析场景解决方案：")]),s._v(" "),n("ol",[n("li",[s._v("ES中的多index分布式Join查询")]),s._v(" "),n("li",[s._v("Doris和ES中的表联合查询，更复杂的全文检索过滤")])]),s._v(" "),n("p",[s._v("本文档主要介绍该功能的实现原理、使用方式等。")]),s._v(" "),n("h2",{attrs:{id:"名词解释"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#名词解释"}},[s._v("#")]),s._v(" 名词解释")]),s._v(" "),n("h3",{attrs:{id:"doris相关"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#doris相关"}},[s._v("#")]),s._v(" Doris相关")]),s._v(" "),n("ul",[n("li",[s._v("FE：Frontend，Doris 的前端节点,负责元数据管理和请求接入")]),s._v(" "),n("li",[s._v("BE：Backend，Doris 的后端节点,负责查询执行和数据存储")])]),s._v(" "),n("h3",{attrs:{id:"es相关"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#es相关"}},[s._v("#")]),s._v(" ES相关")]),s._v(" "),n("ul",[n("li",[s._v("DataNode：ES的数据存储与计算节点")]),s._v(" "),n("li",[s._v("MasterNode：ES的Master节点，管理元数据、节点、数据分布等")]),s._v(" "),n("li",[s._v("scroll：ES内置的数据集游标特性，用来对数据进行流式扫描和过滤")]),s._v(" "),n("li",[s._v("_source: 导入时传入的原始JSON格式文档内容")]),s._v(" "),n("li",[s._v("doc_values: ES/Lucene 中字段的列式存储定义")]),s._v(" "),n("li",[s._v("keyword: 字符串类型字段，ES/Lucene不会对文本内容进行分词处理")]),s._v(" "),n("li",[s._v("text: 字符串类型字段，ES/Lucene会对文本内容进行分词处理，分词器需要用户指定，默认为standard英文分词器")])]),s._v(" "),n("h2",{attrs:{id:"使用方法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#使用方法"}},[s._v("#")]),s._v(" 使用方法")]),s._v(" "),n("h3",{attrs:{id:"创建es索引"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#创建es索引"}},[s._v("#")]),s._v(" 创建ES索引")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('PUT test\n{\n   "settings": {\n      "index": {\n         "number_of_shards": "1",\n         "number_of_replicas": "0"\n      }\n   },\n   "mappings": {\n      "doc": { // ES 7.x版本之后创建索引时不需要指定type，会有一个默认且唯一的`_doc` type\n         "properties": {\n            "k1": {\n               "type": "long"\n            },\n            "k2": {\n               "type": "date"\n            },\n            "k3": {\n               "type": "keyword"\n            },\n            "k4": {\n               "type": "text",\n               "analyzer": "standard"\n            },\n            "k5": {\n               "type": "float"\n            }\n         }\n      }\n   }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br")])]),n("h3",{attrs:{id:"es索引导入数据"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#es索引导入数据"}},[s._v("#")]),s._v(" ES索引导入数据")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /_bulk\n{"index":{"_index":"test","_type":"doc"}}\n{ "k1" : 100, "k2": "2020-01-01", "k3": "Trying out Elasticsearch", "k4": "Trying out Elasticsearch", "k5": 10.0}\n{"index":{"_index":"test","_type":"doc"}}\n{ "k1" : 100, "k2": "2020-01-01", "k3": "Trying out Doris", "k4": "Trying out Doris", "k5": 10.0}\n{"index":{"_index":"test","_type":"doc"}}\n{ "k1" : 100, "k2": "2020-01-01", "k3": "Doris On ES", "k4": "Doris On ES", "k5": 10.0}\n{"index":{"_index":"test","_type":"doc"}}\n{ "k1" : 100, "k2": "2020-01-01", "k3": "Doris", "k4": "Doris", "k5": 10.0}\n{"index":{"_index":"test","_type":"doc"}}\n{ "k1" : 100, "k2": "2020-01-01", "k3": "ES", "k4": "ES", "k5": 10.0}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br")])]),n("h3",{attrs:{id:"doris中创建es外表"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#doris中创建es外表"}},[s._v("#")]),s._v(" Doris中创建ES外表")]),s._v(" "),n("p",[s._v("具体建表语法参照："),n("RouterLink",{attrs:{to:"/zh-CN/docs/sql-manual/sql-reference/Data-Definition-Statements/Create/CREATE-TABLE.html"}},[s._v("CREATE TABLE")])],1),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('CREATE EXTERNAL TABLE `test` // 不指定schema，自动拉取es mapping进行建表 \nENGINE=ELASTICSEARCH \nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test",\n"type" = "doc",\n"user" = "root",\n"password" = "root"\n);\n\nCREATE EXTERNAL TABLE `test` (\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH // ENGINE必须是Elasticsearch\nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test",\n"type" = "doc",\n"user" = "root",\n"password" = "root"\n);\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("p",[s._v("参数说明：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("参数")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[n("strong",[s._v("hosts")])]),s._v(" "),n("td",[s._v("ES集群地址，可以是一个或多个，也可以是ES前端的负载均衡地址")])]),s._v(" "),n("tr",[n("td",[n("strong",[s._v("index")])]),s._v(" "),n("td",[s._v("对应的ES的index名字，支持alias，如果使用doc_value，需要使用真实的名称")])]),s._v(" "),n("tr",[n("td",[n("strong",[s._v("type")])]),s._v(" "),n("td",[s._v("index的type，ES 7.x及以后的版本不传此参数")])]),s._v(" "),n("tr",[n("td",[n("strong",[s._v("user")])]),s._v(" "),n("td",[s._v("ES集群用户名")])]),s._v(" "),n("tr",[n("td",[n("strong",[s._v("password")])]),s._v(" "),n("td",[s._v("对应用户的密码信息")])])])]),s._v(" "),n("ul",[n("li",[s._v("ES 7.x之前的集群请注意在建表的时候选择正确的"),n("strong",[s._v("索引类型type")])]),s._v(" "),n("li",[s._v("认证方式目前仅支持Http Basic认证，并且需要确保该用户有访问: /_cluster/state/、_nodes/http等路径和index的读权限; 集群未开启安全认证，用户名和密码不需要设置")]),s._v(" "),n("li",[s._v("Doris表中的列名需要和ES中的字段名完全匹配，字段类型应该保持一致")]),s._v(" "),n("li",[n("strong",[s._v("ENGINE")]),s._v("必须是 "),n("strong",[s._v("Elasticsearch")])])]),s._v(" "),n("h5",{attrs:{id:"过滤条件下推"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#过滤条件下推"}},[s._v("#")]),s._v(" 过滤条件下推")]),s._v(" "),n("p",[n("code",[s._v("Doris On ES")]),s._v("一个重要的功能就是过滤条件的下推: 过滤条件下推给ES，这样只有真正满足条件的数据才会被返回，能够显著的提高查询性能和降低Doris和Elasticsearch的CPU、memory、IO使用量")]),s._v(" "),n("p",[s._v("下面的操作符(Operators)会被优化成如下ES Query:")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("SQL syntax")]),s._v(" "),n("th",{staticStyle:{"text-align":"center"}},[s._v("ES 5.x+ syntax")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("=")]),s._v(" "),n("td",{staticStyle:{"text-align":"center"}},[s._v("term query")])]),s._v(" "),n("tr",[n("td",[s._v("in")]),s._v(" "),n("td",{staticStyle:{"text-align":"center"}},[s._v("terms query")])]),s._v(" "),n("tr",[n("td",[s._v("> , < , >= , ⇐")]),s._v(" "),n("td",{staticStyle:{"text-align":"center"}},[s._v("range query")])]),s._v(" "),n("tr",[n("td",[s._v("and")]),s._v(" "),n("td",{staticStyle:{"text-align":"center"}},[s._v("bool.filter")])]),s._v(" "),n("tr",[n("td",[s._v("or")]),s._v(" "),n("td",{staticStyle:{"text-align":"center"}},[s._v("bool.should")])]),s._v(" "),n("tr",[n("td",[s._v("not")]),s._v(" "),n("td",{staticStyle:{"text-align":"center"}},[s._v("bool.must_not")])]),s._v(" "),n("tr",[n("td",[s._v("not in")]),s._v(" "),n("td",{staticStyle:{"text-align":"center"}},[s._v("bool.must_not + terms query")])]),s._v(" "),n("tr",[n("td",[s._v("is_not_null")]),s._v(" "),n("td",{staticStyle:{"text-align":"center"}},[s._v("exists query")])]),s._v(" "),n("tr",[n("td",[s._v("is_null")]),s._v(" "),n("td",{staticStyle:{"text-align":"center"}},[s._v("bool.must_not + exists query")])]),s._v(" "),n("tr",[n("td",[s._v("esquery")]),s._v(" "),n("td",{staticStyle:{"text-align":"center"}},[s._v("ES原生json形式的QueryDSL")])])])]),s._v(" "),n("h5",{attrs:{id:"数据类型映射"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#数据类型映射"}},[s._v("#")]),s._v(" 数据类型映射")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("Doris\\ES")]),s._v(" "),n("th",[s._v("byte")]),s._v(" "),n("th",[s._v("short")]),s._v(" "),n("th",[s._v("integer")]),s._v(" "),n("th",[s._v("long")]),s._v(" "),n("th",[s._v("float")]),s._v(" "),n("th",[s._v("double")]),s._v(" "),n("th",[s._v("keyword")]),s._v(" "),n("th",[s._v("text")]),s._v(" "),n("th",[s._v("date")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[s._v("tinyint")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("smallint")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("int")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("bigint")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("float")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("double")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("char")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("varchar")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td",[s._v("√")]),s._v(" "),n("td")]),s._v(" "),n("tr",[n("td",[s._v("date")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td",[s._v("√")])]),s._v(" "),n("tr",[n("td",[s._v("datetime")]),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td"),s._v(" "),n("td",[s._v("√")])])])]),s._v(" "),n("h3",{attrs:{id:"启用列式扫描优化查询速度-enable-docvalue-scan-true"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#启用列式扫描优化查询速度-enable-docvalue-scan-true"}},[s._v("#")]),s._v(" 启用列式扫描优化查询速度(enable_docvalue_scan=true)")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('CREATE EXTERNAL TABLE `test` (\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test",\n"user" = "root",\n"password" = "root",\n"enable_docvalue_scan" = "true"\n);\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("参数说明：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("参数")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[n("strong",[s._v("enable_docvalue_scan")])]),s._v(" "),n("td",[s._v("是否开启通过ES/Lucene列式存储获取查询字段的值，默认为false")])])])]),s._v(" "),n("p",[s._v("开启后Doris从ES中获取数据会遵循以下两个原则：")]),s._v(" "),n("ul",[n("li",[n("strong",[s._v("尽力而为")]),s._v(": 自动探测要读取的字段是否开启列式存储(doc_value: true)，如果获取的字段全部有列存，Doris会从列式存储中获取所有字段的值")]),s._v(" "),n("li",[n("strong",[s._v("自动降级")]),s._v(": 如果要获取的字段只要有一个字段没有列存，所有字段的值都会从行存"),n("code",[s._v("_source")]),s._v("中解析获取")])]),s._v(" "),n("h5",{attrs:{id:"优势"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#优势"}},[s._v("#")]),s._v(" 优势：")]),s._v(" "),n("p",[s._v("默认情况下，Doris On ES会从行存也就是"),n("code",[s._v("_source")]),s._v("中获取所需的所有列，"),n("code",[s._v("_source")]),s._v("的存储采用的行式+json的形式存储，在批量读取性能上要劣于列式存储，尤其在只需要少数列的情况下尤为明显，只获取少数列的情况下，docvalue的性能大约是_source性能的十几倍")]),s._v(" "),n("h5",{attrs:{id:"注意"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#注意"}},[s._v("#")]),s._v(" 注意")]),s._v(" "),n("ol",[n("li",[n("code",[s._v("text")]),s._v("类型的字段在ES中是没有列式存储，因此如果要获取的字段值有"),n("code",[s._v("text")]),s._v("类型字段会自动降级为从"),n("code",[s._v("_source")]),s._v("中获取")]),s._v(" "),n("li",[s._v("在获取的字段数量过多的情况下("),n("code",[s._v(">= 25")]),s._v(")，从"),n("code",[s._v("docvalue")]),s._v("中获取字段值的性能会和从"),n("code",[s._v("_source")]),s._v("中获取字段值基本一样")])]),s._v(" "),n("h3",{attrs:{id:"探测keyword类型字段-enable-keyword-sniff-true"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#探测keyword类型字段-enable-keyword-sniff-true"}},[s._v("#")]),s._v(" 探测keyword类型字段(enable_keyword_sniff=true)")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('CREATE EXTERNAL TABLE `test` (\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test",\n"user" = "root",\n"password" = "root",\n"enable_keyword_sniff" = "true"\n);\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("参数说明：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("参数")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[n("strong",[s._v("enable_keyword_sniff")])]),s._v(" "),n("td",[s._v("是否对ES中字符串类型分词类型("),n("strong",[s._v("text")]),s._v(") "),n("code",[s._v("fields")]),s._v(" 进行探测，获取额外的未分词("),n("strong",[s._v("keyword")]),s._v(")字段名(multi-fields机制)")])])])]),s._v(" "),n("p",[s._v("在ES中可以不建立index直接进行数据导入，这时候ES会自动创建一个新的索引，针对字符串类型的字段ES会创建一个既有"),n("code",[s._v("text")]),s._v("类型的字段又有"),n("code",[s._v("keyword")]),s._v("类型的字段，这就是ES的multi fields特性，mapping如下：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('"k4": {\n   "type": "text",\n   "fields": {\n      "keyword": {   \n         "type": "keyword",\n         "ignore_above": 256\n      }\n   }\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("对k4进行条件过滤时比如=，Doris On ES会将查询转换为ES的TermQuery")]),s._v(" "),n("p",[s._v("SQL过滤条件：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('k4 = "Doris On ES"\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("p",[s._v("转换成ES的query DSL为：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('"term" : {\n    "k4": "Doris On ES"\n\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("因为k4的第一字段类型为"),n("code",[s._v("text")]),s._v("，在数据导入的时候就会根据k4设置的分词器(如果没有设置，就是standard分词器)进行分词处理得到doris、on、es三个Term，如下ES analyze API分析：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('POST /_analyze\n{\n  "analyzer": "standard",\n  "text": "Doris On ES"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("分词的结果是：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('{\n   "tokens": [\n      {\n         "token": "doris",\n         "start_offset": 0,\n         "end_offset": 5,\n         "type": "<ALPHANUM>",\n         "position": 0\n      },\n      {\n         "token": "on",\n         "start_offset": 6,\n         "end_offset": 8,\n         "type": "<ALPHANUM>",\n         "position": 1\n      },\n      {\n         "token": "es",\n         "start_offset": 9,\n         "end_offset": 11,\n         "type": "<ALPHANUM>",\n         "position": 2\n      }\n   ]\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br")])]),n("p",[s._v("查询时使用的是：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('"term" : {\n    "k4": "Doris On ES"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[n("code",[s._v("Doris On ES")]),s._v("这个term匹配不到词典中的任何term，不会返回任何结果，而启用"),n("code",[s._v("enable_keyword_sniff: true")]),s._v("会自动将"),n("code",[s._v('k4 = "Doris On ES"')]),s._v("转换成"),n("code",[s._v('k4.keyword = "Doris On ES"')]),s._v("来完全匹配SQL语义，转换后的ES query DSL为:")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('"term" : {\n    "k4.keyword": "Doris On ES"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br")])]),n("p",[n("code",[s._v("k4.keyword")]),s._v(" 的类型是"),n("code",[s._v("keyword")]),s._v("，数据写入ES中是一个完整的term，所以可以匹配")]),s._v(" "),n("h3",{attrs:{id:"开启节点自动发现-默认为true-es-nodes-discovery-true"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#开启节点自动发现-默认为true-es-nodes-discovery-true"}},[s._v("#")]),s._v(" 开启节点自动发现, 默认为true(es_nodes_discovery=true)")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('CREATE EXTERNAL TABLE `test` (\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test",\n"user" = "root",\n"password" = "root",\n"nodes_discovery" = "true"\n);\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("参数说明：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("参数")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[n("strong",[s._v("es_nodes_discovery")])]),s._v(" "),n("td",[s._v("是否开启es节点发现，默认为true")])])])]),s._v(" "),n("p",[s._v("当配置为true时，Doris将从ES找到所有可用的相关数据节点(在上面分配的分片)。如果ES数据节点的地址没有被Doris BE访问，则设置为false。ES集群部署在与公共Internet隔离的内网，用户通过代理访问")]),s._v(" "),n("h3",{attrs:{id:"es集群是否开启https访问模式-如果开启应设置为true-默认为false-http-ssl-enabled-true"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#es集群是否开启https访问模式-如果开启应设置为true-默认为false-http-ssl-enabled-true"}},[s._v("#")]),s._v(" ES集群是否开启https访问模式，如果开启应设置为"),n("code",[s._v("true")]),s._v("，默认为false(http_ssl_enabled=true)")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('CREATE EXTERNAL TABLE `test` (\n  `k1` bigint(20) COMMENT "",\n  `k2` datetime COMMENT "",\n  `k3` varchar(20) COMMENT "",\n  `k4` varchar(100) COMMENT "",\n  `k5` float COMMENT ""\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n"hosts" = "http://192.168.0.1:8200,http://192.168.0.2:8200",\n"index" = "test",\n"user" = "root",\n"password" = "root",\n"http_ssl_enabled" = "true"\n);\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("参数说明：")]),s._v(" "),n("table",[n("thead",[n("tr",[n("th",[s._v("参数")]),s._v(" "),n("th",[s._v("说明")])])]),s._v(" "),n("tbody",[n("tr",[n("td",[n("strong",[s._v("http_ssl_enabled")])]),s._v(" "),n("td",[s._v("ES集群是否开启https访问模式")])])])]),s._v(" "),n("p",[s._v("目前会fe/be实现方式为信任所有，这是临时解决方案，后续会使用真实的用户配置证书")]),s._v(" "),n("h3",{attrs:{id:"查询用法"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#查询用法"}},[s._v("#")]),s._v(" 查询用法")]),s._v(" "),n("p",[s._v("完成在Doris中建立ES外表后，除了无法使用Doris中的数据模型(rollup、预聚合、物化视图等)外并无区别")]),s._v(" "),n("h4",{attrs:{id:"基本查询"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#基本查询"}},[s._v("#")]),s._v(" 基本查询")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("select * from es_table where k1 > 1000 and k3 ='term' or k4 like 'fu*z_'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("h4",{attrs:{id:"扩展的esquery-field-querydsl"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#扩展的esquery-field-querydsl"}},[s._v("#")]),s._v(" 扩展的esquery(field, QueryDSL)")]),s._v(" "),n("p",[s._v("通过"),n("code",[s._v("esquery(field, QueryDSL)")]),s._v("函数将一些无法用sql表述的query如match_phrase、geoshape等下推给ES进行过滤处理，"),n("code",[s._v("esquery")]),s._v("的第一个列名参数用于关联"),n("code",[s._v("index")]),s._v("，第二个参数是ES的基本"),n("code",[s._v("Query DSL")]),s._v("的json表述，使用花括号"),n("code",[s._v("{}")]),s._v("包含，json的"),n("code",[s._v("root key")]),s._v("有且只能有一个，如match_phrase、geo_shape、bool等")]),s._v(" "),n("p",[s._v("match_phrase查询：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('select * from es_table where esquery(k4, \'{\n        "match_phrase": {\n           "k4": "doris on es"\n        }\n    }\');\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("p",[s._v("geo相关查询：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('select * from es_table where esquery(k4, \'{\n      "geo_shape": {\n         "location": {\n            "shape": {\n               "type": "envelope",\n               "coordinates": [\n                  [\n                     13,\n                     53\n                  ],\n                  [\n                     14,\n                     52\n                  ]\n               ]\n            },\n            "relation": "within"\n         }\n      }\n   }\');\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[s._v("bool查询：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('select * from es_table where esquery(k4, \' {\n         "bool": {\n            "must": [\n               {\n                  "terms": {\n                     "k1": [\n                        11,\n                        12\n                     ]\n                  }\n               },\n               {\n                  "terms": {\n                     "k2": [\n                        100\n                     ]\n                  }\n               }\n            ]\n         }\n      }\');\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br")])]),n("h2",{attrs:{id:"原理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#原理"}},[s._v("#")]),s._v(" 原理")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("+----------------------------------------------+\n|                                              |\n| Doris      +------------------+              |\n|            |       FE         +--------------+-------+\n|            |                  |  Request Shard Location\n|            +--+-------------+-+              |       |\n|               ^             ^                |       |\n|               |             |                |       |\n|  +-------------------+ +------------------+  |       |\n|  |            |      | |    |             |  |       |\n|  | +----------+----+ | | +--+-----------+ |  |       |\n|  | |      BE       | | | |      BE      | |  |       |\n|  | +---------------+ | | +--------------+ |  |       |\n+----------------------------------------------+       |\n   |        |          | |        |         |          |\n   |        |          | |        |         |          |\n   |    HTTP SCROLL    | |    HTTP SCROLL   |          |\n+-----------+---------------------+------------+       |\n|  |        v          | |        v         |  |       |\n|  | +------+--------+ | | +------+-------+ |  |       |\n|  | |               | | | |              | |  |       |\n|  | |   DataNode    | | | |   DataNode   +<-----------+\n|  | |               | | | |              | |  |       |\n|  | |               +<--------------------------------+\n|  | +---------------+ | | |--------------| |  |       |\n|  +-------------------+ +------------------+  |       |\n|   Same Physical Node                         |       |\n|                                              |       |\n|           +-----------------------+          |       |\n|           |                       |          |       |\n|           |      MasterNode       +<-----------------+\n| ES        |                       |          |\n|           +-----------------------+          |\n+----------------------------------------------+\n\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br")])]),n("ol",[n("li",[n("p",[s._v("创建ES外表后，FE会请求建表指定的主机，获取所有节点的HTTP端口信息以及index的shard分布信息等，如果请求失败会顺序遍历host列表直至成功或完全失败")])]),s._v(" "),n("li",[n("p",[s._v("查询时会根据FE得到的一些节点信息和index的元数据信息，生成查询计划并发给对应的BE节点")])]),s._v(" "),n("li",[n("p",[s._v("BE节点会根据"),n("code",[s._v("就近原则")]),s._v("即优先请求本地部署的ES节点，BE通过"),n("code",[s._v("HTTP Scroll")]),s._v("方式流式的从ES index的每个分片中并发的从"),n("code",[s._v("_source")]),s._v("或"),n("code",[s._v("docvalue")]),s._v("中获取数据")])]),s._v(" "),n("li",[n("p",[s._v("Doris计算完结果后，返回给用户")])])]),s._v(" "),n("h2",{attrs:{id:"最佳实践"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#最佳实践"}},[s._v("#")]),s._v(" 最佳实践")]),s._v(" "),n("h3",{attrs:{id:"时间类型字段使用建议"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#时间类型字段使用建议"}},[s._v("#")]),s._v(" 时间类型字段使用建议")]),s._v(" "),n("p",[s._v("在ES中，时间类型的字段使用十分灵活，但是在Doris On ES中如果对时间类型字段的类型设置不当，则会造成过滤条件无法下推")]),s._v(" "),n("p",[s._v("创建索引时对时间类型格式的设置做最大程度的格式兼容:")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v(' "dt": {\n     "type": "date",\n     "format": "yyyy-MM-dd HH:mm:ss||yyyy-MM-dd||epoch_millis"\n }\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[s._v("在Doris中建立该字段时建议设置为"),n("code",[s._v("date")]),s._v("或"),n("code",[s._v("datetime")]),s._v(",也可以设置为"),n("code",[s._v("varchar")]),s._v("类型, 使用如下SQL语句都可以直接将过滤条件下推至ES：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("select * from doe where k2 > '2020-06-21';\n\nselect * from doe where k2 < '2020-06-21 12:00:00'; \n\nselect * from doe where k2 < 1593497011; \n\nselect * from doe where k2 < now();\n\nselect * from doe where k2 < date_format(now(), '%Y-%m-%d');\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br")])]),n("p",[s._v("注意:")]),s._v(" "),n("ul",[n("li",[s._v("在ES中如果不对时间类型的字段设置"),n("code",[s._v("format")]),s._v(", 默认的时间类型字段格式为")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("strict_date_optional_time||epoch_millis\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br")])]),n("ul",[n("li",[s._v("导入到ES的日期字段如果是时间戳需要转换成"),n("code",[s._v("ms")]),s._v(", ES内部处理时间戳都是按照"),n("code",[s._v("ms")]),s._v("进行处理的, 否则Doris On ES会出现显示错误")])]),s._v(" "),n("h3",{attrs:{id:"获取es元数据字段-id"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#获取es元数据字段-id"}},[s._v("#")]),s._v(" 获取ES元数据字段"),n("code",[s._v("_id")])]),s._v(" "),n("p",[s._v("导入文档在不指定"),n("code",[s._v("_id")]),s._v("的情况下ES会给每个文档分配一个全局唯一的"),n("code",[s._v("_id")]),s._v("即主键, 用户也可以在导入时为文档指定一个含有特殊业务意义的"),n("code",[s._v("_id")]),s._v("; 如果需要在Doris On ES中获取该字段值，建表时可以增加类型为"),n("code",[s._v("varchar")]),s._v("的"),n("code",[s._v("_id")]),s._v("字段：")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('CREATE EXTERNAL TABLE `doe` (\n  `_id` varchar COMMENT "",\n  `city`  varchar COMMENT ""\n) ENGINE=ELASTICSEARCH\nPROPERTIES (\n"hosts" = "http://127.0.0.1:8200",\n"user" = "root",\n"password" = "root",\n"index" = "doe"\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br")])]),n("p",[s._v("注意:")]),s._v(" "),n("ol",[n("li",[n("code",[s._v("_id")]),s._v("字段的过滤条件仅支持"),n("code",[s._v("=")]),s._v("和"),n("code",[s._v("in")]),s._v("两种")]),s._v(" "),n("li",[n("code",[s._v("_id")]),s._v("字段只能是"),n("code",[s._v("varchar")]),s._v("类型")])]),s._v(" "),n("h2",{attrs:{id:"q-a"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#q-a"}},[s._v("#")]),s._v(" Q&A")]),s._v(" "),n("ol",[n("li",[n("p",[s._v("Doris On ES对ES的版本要求")]),s._v(" "),n("p",[s._v("ES主版本大于5，ES在2.x之前和5.x之后数据的扫描方式不同，目前支持仅5.x之后的")])]),s._v(" "),n("li",[n("p",[s._v("是否支持X-Pack认证的ES集群")]),s._v(" "),n("p",[s._v("支持所有使用HTTP Basic认证方式的ES集群")])]),s._v(" "),n("li",[n("p",[s._v("一些查询比请求ES慢很多")]),s._v(" "),n("p",[s._v("是，比如_count相关的query等，ES内部会直接读取满足条件的文档个数相关的元数据，不需要对真实的数据进行过滤")])]),s._v(" "),n("li",[n("p",[s._v("聚合操作是否可以下推")]),s._v(" "),n("p",[s._v("目前Doris On ES不支持聚合操作如sum, avg, min/max 等下推，计算方式是批量流式的从ES获取所有满足条件的文档，然后在Doris中进行计算")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);