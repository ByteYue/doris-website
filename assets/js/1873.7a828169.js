(window.webpackJsonp=window.webpackJsonp||[]).push([[1873],{2500:function(e,t,s){"use strict";s.r(t);var a=s(15),n=Object(a.a)({},(function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"user-defined-function-rpc"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#user-defined-function-rpc"}},[e._v("#")]),e._v(" User Defined Function Rpc")]),e._v(" "),s("p",[e._v("Remote UDAF Service The Remote UDAF Service can be accessed through RPC to implement the execution of user-defined functions. Compared with Native UDAF implementations, Remote UDAF Service has the following advantages and limitations:")]),e._v(" "),s("ol",[s("li",[s("p",[e._v("The advantage")]),e._v(" "),s("ul",[s("li",[e._v("Cross-language: UDAF services can be written in all languages supported by Protobuf.")]),e._v(" "),s("li",[e._v("Security: UDAF execution failure or crash only affects the UDAF Service and does not cause the Doris process to crash.")]),e._v(" "),s("li",[e._v("Flexibility: Any other Service or library class can be invoked within a UDAF Service to meet a wider variety of business requirements.")])])]),e._v(" "),s("li",[s("p",[e._v("Restrictions on use")]),e._v(" "),s("ul",[s("li",[e._v("Performance: Compared to Native UDAFs, UDAF services incur extra network overhead and thus have much lower performance than Native UDAFs. At the same time, the implementation of the UDAF Service also affects the execution efficiency of the function. Users need to deal with problems such as high concurrency and thread safety by themselves.")]),e._v(" "),s("li",[e._v("Single line mode and batch mode: Doris's original query execution framework based on row memory would execute one UDAF RPC call for each row of data, so the execution efficiency was very poor. However, under the new vectorization execution framework, one UDAF RPC call would be executed for each batch of data, so the performance was significantly improved. In actual tests, the performance of Remote UDAF based on vectorization and batch processing is similar to that of Native UDAF based on rowmemory, which can be used for reference.")])])])]),e._v(" "),s("h2",{attrs:{id:"write-udaf-functions"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#write-udaf-functions"}},[e._v("#")]),e._v(" Write UDAF functions")]),e._v(" "),s("p",[e._v("This section describes how to develop a Remote RPC Service. Samples for the Java version are provided under "),s("code",[e._v("samples/doris-demo/UDAF-demo/")]),e._v(" for your reference.")]),e._v(" "),s("h3",{attrs:{id:"copy-the-proto-file"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#copy-the-proto-file"}},[e._v("#")]),e._v(" Copy the proto file")]),e._v(" "),s("p",[e._v("Copy gensrc/proto/function_service.proto and gensrc/proto/types.proto to Rpc service")]),e._v(" "),s("ul",[s("li",[e._v("function_service.proto\n"),s("ul",[s("li",[e._v("PFunctionCallRequest\n"),s("ul",[s("li",[e._v("function_name：The function name, corresponding to the symbol specified when the function was created")]),e._v(" "),s("li",[e._v("args：The parameters passed by the method")]),e._v(" "),s("li",[e._v("context：Querying context Information")])])]),e._v(" "),s("li",[e._v("PFunctionCallResponse\n"),s("ul",[s("li",[e._v("result：Return result")]),e._v(" "),s("li",[e._v("status：Return Status, 0 indicates normal")])])]),e._v(" "),s("li",[e._v("PCheckFunctionRequest\n"),s("ul",[s("li",[e._v("function：Function related information")]),e._v(" "),s("li",[e._v("match_type：Matching type")])])]),e._v(" "),s("li",[e._v("PCheckFunctionResponse\n"),s("ul",[s("li",[e._v("status：Return status, 0 indicates normal")])])])])])]),e._v(" "),s("h3",{attrs:{id:"generated-interface"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#generated-interface"}},[e._v("#")]),e._v(" Generated interface")]),e._v(" "),s("p",[e._v("Use protoc generate code, and specific parameters are viewed using protoc -h")]),e._v(" "),s("h3",{attrs:{id:"implementing-an-interface"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#implementing-an-interface"}},[e._v("#")]),e._v(" Implementing an interface")]),e._v(" "),s("p",[e._v("The following three methods need to be implemented")]),e._v(" "),s("ul",[s("li",[e._v("fnCall：Used to write computational logic")]),e._v(" "),s("li",[e._v("checkFn：Used to verify function names, parameters, and return values when creating UDAFs")]),e._v(" "),s("li",[e._v("handShake：Used for interface probe")])]),e._v(" "),s("h2",{attrs:{id:"create-udaf"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#create-udaf"}},[e._v("#")]),e._v(" Create UDAF")]),e._v(" "),s("p",[e._v("Currently, UDAF and UDTF are not supported")]),e._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("CREATE")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FUNCTION")]),e._v(" \nname "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RETURNS")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),e._v(" rettype\nPROPERTIES "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"key"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"value"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("]")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\t\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("p",[e._v("Instructions:")]),e._v(" "),s("ol",[s("li",[e._v("PROPERTIES中"),s("code",[e._v("symbol")]),e._v("Represents the name of the method passed by the RPC call, which must be set。")]),e._v(" "),s("li",[e._v("PROPERTIES中"),s("code",[e._v("object_file")]),e._v("Represents the RPC service address. Currently, a single address and a cluster address in BRPC-compatible format are supported. Refer to the cluster connection mode"),s("a",{attrs:{href:"https://github.com/apache/incubator-brpc/blob/master/docs/cn/client.md#%E8%BF%9E%E6%8E%A5%E6%9C%8D%E5%8A%A1%E9%9B%86%E7%BE%A4",target:"_blank",rel:"noopener noreferrer"}},[e._v("Format specification"),s("OutboundLink")],1),e._v("。")]),e._v(" "),s("li",[e._v("PROPERTIES中"),s("code",[e._v("type")]),e._v("Indicates the UDAF call type, which is Native by default. Rpc is transmitted when Rpc UDAF is used。")])]),e._v(" "),s("p",[e._v("Sample:")]),e._v(" "),s("div",{staticClass:"language-sql line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sql"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("CREATE")]),e._v(" AGGREGATE "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("FUNCTION")]),e._v(" rpc_sum"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("RETURNS")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("int")]),e._v(" PROPERTIES "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"TYPE"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"RPC"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"OBJECT_FILE"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"127.0.0.1:9000"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"update_fn"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"rpc_sum_update"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"merge_fn"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"rpc_sum_merge"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"finalize_fn"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v('"rpc_sum_finalize"')]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(";")]),e._v("\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br")])]),s("h2",{attrs:{id:"use-udaf"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#use-udaf"}},[e._v("#")]),e._v(" Use UDAF")]),e._v(" "),s("p",[e._v("Users must have the "),s("code",[e._v("SELECT")]),e._v(" permission of the corresponding database to use UDAF/UDAF.")]),e._v(" "),s("p",[e._v("The use of UDAF is consistent with ordinary function methods. The only difference is that the scope of built-in functions is global, and the scope of UDAF is internal to DB. When the link session is inside the data, directly using the UDAF name will find the corresponding UDAF inside the current DB. Otherwise, the user needs to display the specified UDAF database name, such as "),s("code",[e._v("dbName")]),e._v("."),s("code",[e._v("funcName")]),e._v(".")]),e._v(" "),s("h2",{attrs:{id:"delete-udaf"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#delete-udaf"}},[e._v("#")]),e._v(" Delete UDAF")]),e._v(" "),s("p",[e._v("When you no longer need UDAF functions, you can delete a UDAF function by the following command, you can refer to "),s("code",[e._v("DROP FUNCTION")]),e._v(".")]),e._v(" "),s("h2",{attrs:{id:"example"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#example"}},[e._v("#")]),e._v(" Example")]),e._v(" "),s("p",[e._v("Examples of rpc server implementations and cpp/java/python languages are provided in the "),s("code",[e._v("samples/doris-demo/")]),e._v(" directory. See the "),s("code",[e._v("README.md")]),e._v(" in each directory for details on how to use it.")])])}),[],!1,null,null,null);t.default=n.exports}}]);